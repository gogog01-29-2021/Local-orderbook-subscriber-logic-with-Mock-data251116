#!/usr/bin/env python3
"""
Performance Analysis Tool for Ring Buffer Optimization
Analyzes the CSV logs generated by the experiments
"""

import pandas as pd
import glob
import os
import sys

def analyze_performance_logs(results_dir="experiment_results"):
    """Analyze all performance logs in the results directory"""

    if not os.path.exists(results_dir):
        print(f"Error: {results_dir} directory not found!")
        print("Please run experiments first using: ./run_experiments.sh")
        return

    # Find all performance CSV files
    perf_files = glob.glob(f"{results_dir}/test_*_perf.csv")

    if not perf_files:
        print("No performance logs found!")
        return

    print(f"\n{'='*60}")
    print(f"Found {len(perf_files)} test results")
    print(f"{'='*60}\n")

    # Analyze each test
    results = []

    for perf_file in sorted(perf_files):
        test_num = perf_file.split("_")[1]
        output_file = f"{results_dir}/test_{test_num}_output.txt"

        # Read the output file to get configuration
        config = {}
        summary = {}

        if os.path.exists(output_file):
            with open(output_file, 'r') as f:
                for line in f:
                    if "Config:" in line:
                        # Parse: Config: buffer=1024 window=10ms watermark=5ms proc_cap=200 duration=10s
                        parts = line.split("Config:")[1].strip().split()
                        for part in parts:
                            key, value = part.split("=")
                            config[key] = value

                    if "Total Windows Published:" in line:
                        summary['windows'] = int(line.split(":")[1].strip())
                    if "Total Events Processed:" in line:
                        summary['events_processed'] = int(line.split(":")[1].strip())
                    if "Total Events Skipped:" in line:
                        summary['events_skipped'] = int(line.split(":")[1].strip())
                    if "Throughput:" in line:
                        summary['throughput'] = float(line.split(":")[1].split()[0].strip())
                    if "Event Processing Rate:" in line:
                        summary['event_rate'] = float(line.split(":")[1].split()[0].strip())

        if config and summary:
            result = {
                'test': test_num,
                'buffer_capacity': config.get('buffer', 'N/A'),
                'window_size': config.get('window', 'N/A'),
                'watermark_delay': config.get('watermark', 'N/A'),
                'proc_capacity': config.get('proc_cap', 'N/A'),
                'duration': config.get('duration', 'N/A'),
                'windows_published': summary.get('windows', 0),
                'events_processed': summary.get('events_processed', 0),
                'events_skipped': summary.get('events_skipped', 0),
                'throughput': summary.get('throughput', 0),
                'event_rate': summary.get('event_rate', 0),
                'skip_rate': (summary.get('events_skipped', 0) /
                             max(summary.get('events_processed', 1), 1) * 100)
            }
            results.append(result)

    if not results:
        print("No valid results found!")
        return

    # Convert to DataFrame
    df = pd.DataFrame(results)

    # Print results
    print("\n" + "="*80)
    print("PERFORMANCE SUMMARY")
    print("="*80)
    print(df.to_string(index=False))

    # Find optimal configurations
    print("\n" + "="*80)
    print("OPTIMAL CONFIGURATIONS")
    print("="*80)

    best_throughput = df.loc[df['throughput'].idxmax()]
    print(f"\n✓ Highest Throughput:")
    print(f"  Buffer: {best_throughput['buffer_capacity']}, Window: {best_throughput['window_size']}")
    print(f"  Throughput: {best_throughput['throughput']:.2f} windows/sec")

    lowest_skip = df.loc[df['skip_rate'].idxmin()]
    print(f"\n✓ Lowest Skip Rate:")
    print(f"  Buffer: {lowest_skip['buffer_capacity']}, Window: {lowest_skip['window_size']}")
    print(f"  Skip Rate: {lowest_skip['skip_rate']:.2f}%")

    best_event_rate = df.loc[df['event_rate'].idxmax()]
    print(f"\n✓ Highest Event Processing Rate:")
    print(f"  Buffer: {best_event_rate['buffer_capacity']}, Window: {best_event_rate['window_size']}")
    print(f"  Event Rate: {best_event_rate['event_rate']:.2f} events/sec")

    # Save results
    csv_output = f"{results_dir}/analysis_summary.csv"
    df.to_csv(csv_output, index=False)
    print(f"\n✓ Analysis saved to: {csv_output}")

    # Recommendations
    print("\n" + "="*80)
    print("RECOMMENDATIONS")
    print("="*80)

    avg_skip_rate = df['skip_rate'].mean()
    if avg_skip_rate > 10:
        print("⚠ High skip rate detected! Consider:")
        print("  - Increasing ring buffer capacity")
        print("  - Increasing processor capacity")
        print("  - Decreasing window size for faster processing")
    elif avg_skip_rate < 1:
        print("✓ Skip rate is very low - good configuration!")
        print("  Consider testing smaller buffer sizes to optimize memory usage")
    else:
        print("✓ Skip rate is acceptable")

    print()

if __name__ == "__main__":
    results_dir = sys.argv[1] if len(sys.argv) > 1 else "experiment_results"
    analyze_performance_logs(results_dir)
